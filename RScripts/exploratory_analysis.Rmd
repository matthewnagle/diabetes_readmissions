---
title: "Project"
author: "B203349"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Load packages

```{r echo = TRUE, warning = FALSE, message = FALSE}
library(sparklyr)
library(dplyr)
library(ggplot2)
library(knitr)
library(tidyverse) 
library(lubridate) 
library(maps)
library(ggplot2)
library(countrycode)
```

## Connecting

```{r warning = FALSE}
sc = spark_connect(master = 'local')
```

## Read .csv and create dataframe
```{r}
diabetic_data = spark_read_csv(sc, '/Users/matt/Desktop/Dropbox/Home/College/Edinburgh - MSc Data Science/Big Data Analytics/diabetes_readmissions/RawData/diabetic_data.csv') 
```

# Exploratory analysis

```{r diabetic_data}
glimpse(diabetic_data)
```


```{r diabetic_data, echo=TRUE}
diabetic_data %>% 
  head(15) %>%
  kable()
```
## Readmission
View the breakdown of readmissions

```{r diabetic_data}
diabetic_data %>% 
  count(readmitted) # %>%
  # kable()
```

Create a new column that classifies those readmitted within 30 days and those not

```{r}
diabetic_data = mutate(diabetic_data, early_readmission = ifelse(readmitted == '<30', TRUE, FALSE))
```

```{r}
select(diabetic_data, readmitted, early_readmission) %>%
  head(15) %>%
  kable()
```

```{r diabetic_data}
diabetic_data %>% 
  count(early_readmission) # %>%
  # kable()
```

## proportion of patient gender
```{r diabetic_data}
diabetic_data %>% 
  count(gender) # %>%
  #kable()
```
## Summary statistics
Lab procedures
```{r}
summarise(diabetic_data, mean_num_lab_procedures = mean(num_lab_procedures))
summarise(diabetic_data, min_num_lab_procedures = min(num_lab_procedures))
summarise(diabetic_data, max_num_lab_procedures = max(num_lab_procedures))
median(pull(diabetic_data, num_lab_procedures))
IQR(pull(diabetic_data, num_lab_procedures))
```
Lab procedures by age
```{r}
diabetic_data %>%
  group_by(age) %>%
  summarise(mean_num_lab_procedures = mean(num_lab_procedures)) %>%
  arrange(age)

```

## Diagnoses
list the primary diagnoses
```{r diabetic_data}
diabetic_data %>% 
  count(diag_1) %>%
  #head(15) %>% #reduces to top 15 diagnoses
  arrange(desc(n))%>%
  kable()
```
List the secondary diagnoses
```{r diabetic_data}
diabetic_data %>% 
  count(diag_2) %>%
  #head(15) %>% #reduces to top 15 diagnoses
  arrange(desc(n))%>%
  kable()
```

list the additional secondary diagnoses
```{r diabetic_data}
diabetic_data %>% 
  count(diag_3) %>%
  #head(15) %>% #reduces to top 15 diagnoses
  arrange(desc(n))%>%
  kable()
```

# Plots

```{r}
# Data manipulations are done first using spark
car_group = cars %>%
  group_by(cyl) %>%
  summarise(mpg = sum(mpg, na.rm = TRUE)) %>%
  # collect brings the Spark dataframe back to a regular R dataframe
  collect()

# Now use ggplot on the R dataframe car_group
ggplot(aes(as.factor(cyl), mpg), data = car_group) +
  geom_col(fill = 'SteelBlue') +
  xlab('Cylinders') +
  coord_flip()
```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
